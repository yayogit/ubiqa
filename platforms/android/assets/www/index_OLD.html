<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ubiqarama</title>

    <!-- Bootstrap -->
    <link href="dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- theme css // tema del la app -->
    <link href="assets/css/theme.css" rel="stylesheet">
    <link href="assets/css/icons.css" rel="stylesheet">
    

    <link href="assets/css/simple-sidebar.css" rel="stylesheet">
    
    <link rel="stylesheet" href="js/medium-editor/css/medium-editor.css"> <!-- Core -->
	<link rel="stylesheet" href="js/medium-editor/css/themes/default.css"> <!-- or any other theme -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

     <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    
    <script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="js/jquery/jquery.mobile-1.4.2.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="dist/js/bootstrap.min.js"></script>
    <!-- Custom JavaScript for the Menu Toggle -->

    <!-- Pop Up JS -->
    <link href="assets/css/popup.css" rel="stylesheet">
    <script src="assets/js/popup.js"></script>
    
    <!--  truncating character with ellipsis -->
    <script src="assets/js/succinct.js"></script>
  
    
    <script src="assets/audiojs/audio.min.js"></script>
    
    
<!-- YYY Carga de scripts  -->
    <script src="js/openlayers/OpenLayers.js"></script>
    <script type="text/javascript" charset="utf-8" src="cordova.js"></script> 
    <script src="js/ddc_phonegap_utils.js"></script>
    <script src="js/config_ubiqarama.js"></script>
    <script src="js/model_ubiqarama.js"></script>
    <script src="js/utils_ubiqarama.js"></script>
    <script src="js/api_ubiqarama.js"></script>
    <script src="js/utils_openlayers.js"></script>
    <script src="js/medium-editor/js/medium-editor.js"></script>
    
<!-- Fin YYY Carga de scripts  -->
    
    <!-- Run in full-screen mode. -->
    <meta name="apple-mobile-web-app-capable" content="yes">

    <!-- Make the status bar black with white text. -->
    <meta name="apple-mobile-web-app-status-bar-style" 
          content="black-translucent" >

    <!-- Customize home screen title. -->
    <meta name="apple-mobile-web-app-title" 
          content="Ubiqarama">

    <!-- Disable phone number detection. -->
    <meta name="format-detection" 
          content="telephone=no">

    <!-- Set viewport. -->
    <meta name="viewport" 
          content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <!-- Prevent text size adjustment on orientation change. -->
    <style>html { -webkit-text-size-adjust: 100%; }</style>

    <title>Ubiqarama</title>
 
    <!-- Icons -->
    
    <link rel="icon" href="assets/images/favicon.png">
        
    <!-- iOS 7 iPad (retina) -->
    <link href="assets/images/apple-touch-icon-152x152.png"
          sizes="152x152"
          rel="apple-touch-icon">

    <!-- iOS 7 iPhone (retina) -->
    <link href="assets/images/apple-touch-icon-120x120.png"
          sizes="120x120"
          rel="apple-touch-icon">
    <!-- iOS 7 iPad -->
    <link href="assets/images/apple-touch-icon-76x76.png"
          sizes="76x76"
          rel="apple-touch-icon">
 
 
    <!-- Startup images -->

    <!-- iPhone 5 -->
		<link 	href="assets/images/startup-iphone5@2x.png"
      			media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)"
      			rel="apple-touch-startup-image">		
		<!-- iPhone -->
		<link 	href="assets/images/startup-iphone.png"
      			media="(device-width: 320px) and (device-height: 480px) and (-webkit-device-pixel-ratio: 1)"
      			rel="apple-touch-startup-image">	
		<!-- iPhone (Retina) -->
		<link 	href="assets/images/startup-iphone@2x.png"
      			media="(device-width: 320px) and (device-height: 480px) and (-webkit-device-pixel-ratio: 2)"
      			rel="apple-touch-startup-image">
    
  </head>
  <body onload="init();">
  
    <div id="wrapper">

        <!-- Sidebar -->
        <div id="sidebar-wrapper">
        	<div class='avatar' style="background: url('assets/images/no-avatar.png') center center; background-size: cover">
            </div>
            <ul class="sidebar-nav">
            	
                <li class="sidebar-brand">
                <a id="link_user_alias" href="#">sin iniciar</a>
                </li>
                <li class="proyectos"></li>                
                <li><a href="javascript:window.location='ayuda.html';">Más información</a>
                <li><a href="javascript:logOut();"><span class="icon icon-icn-232"></span> cerrar sesión</a>
                </li>
            </ul>
        </div>

        <!-- Page content -->
        <div id="page-content-wrapper">

            <!-- Keep all page content within the page-content inset div! -->
            <div class="page-content inset">
            	<header class="row toolbar">
              		<h1>
              	 		<img src="assets/images/logo-ubiqarama.png">Ubiqarama
              	 	</h1>
                    <a id="menu-toggle" href="#" class="btn">
                    	<span class="icon icon-icn-349"></span>
                    </a>
                </header>
            <section class="container-fluid">
                
        	<header class="row">
        		<figure class="page-header text-center">      
                	
                	<h2 class="project_name">Nombre del proyecto</h2>
                	<p class="fecha"><span class="icon icon-clock"></span> Fecha</p>
                	
<!-- YYY Mapa de OpenLayers  -->
					<div id="map" class="map" style="border:0; height: 250px; width: 100%"></div>
<!-- Fin YYY Mapa de OpenLayers  -->
                	
                
        		</figure>
            </header>
                 
            <article class="row">
                  
                  <figure class="well">
                    <div class="page-header text-center">
                      <h3>Audio</h3>
                                            
                      <div class="btn-group acciones">
                        <button type="button" class="btn btn-link btn-lg" onclick="addContent('audio');">añadir audio <span class="icon icon-icn-65"></span></button>                        
                      </div>
                    </div>
                    <div class="accordion contents_audio">
					    <!-- Contenidos de tipo Audio -->
					</div>                  
  					</figure>

						<figure class="well">
							<div class="page-header text-center">

								<h3>Imágenes</h3>
								<div class="btn-group acciones">
									<button type="button" class="btn btn-link btn-lg" onclick="addContent('image');">añadir imagen <span class="icon icon-picture"></span></button>									
								</div>
							</div>
							<div class="accordion contents_image">
								<!-- Contenidos de tipo Imagen -->
							</div>
						</figure>

						<figure class="well">
	                    <div class="page-header text-center">
	                    
	                    <h3>videos</h3>
	                    <div class="btn-group acciones">
	                        <button type="button" class="btn btn-link btn-lg"  onclick="addContent('video');">añadir video <span class="icon icon-picture"></span></button>
	                        
	                      </div>
	                    </div>
	                    
	                    <div class="accordion contents_video">
						     <!-- Contenidos de tipo Imagen -->
						  </div>
					  </figure>
                  
                </article>
                
            </section>
        </div>
    </div>
    
    
    
    <div class="console_log"></div>
</div>

    
    <!-- Custom methods and inits -->
    

    
    <script src="assets/js/app.js" type="text/javascript"></script>
<!-- YYY -->
	<script type="text/javascript">
	
		//Inicializar mapa de OpenLayers
		var openLayersUtils = new OpenLayersUtils("map");
		
		var currentProjectID = 0;
		var currentProjectName = "";
		var isEditing = false;
		
		var renderTagList = "";
		function getTagList(){
			if(renderTagList == ""){				
				function tagListOK(result){
					renderTagList +=
						"<div class='accordion-heading'>"+
			    			"<a href='#edit_tags' data-parent='#myAccordion' data-toggle='collapse' class='accordion-toggle'>Temas</a>"+
			   			"</div>"+
						"<div class='accordion-body collapse' id='edit_tags'>"+
							"<div class='accordion-inner item'>"+
								"<div class='btn-group' data-toggle='buttons'>";	
					$.each(result, function (i, tag){
						renderTagList += "<label class='btn btn-link btn-sm'><input type='checkbox' class='chkTag' name='"+tag.name+"' value='"+tag.id+"'>"+tag.name+"</label>";
					});
					renderTagList += 
								"</div>"+
							"</div>"+
						"</div>";					
				}
				APIcalls.getTags(tagListOK);
			}
			return renderTagList;
		}
		
		function setAge (pOptionId){
			var chosenAge = $("."+pOptionId);
			$(".selector_edad").val(chosenAge.data().value);
			$(".selector_edad").html(chosenAge.html());
		}
		
		/**
		 * Obtiene informacion del usuario conectado y la lista de proyectos disponible
		 */
		function init(){
			
			ddcDialog.showProgress("Cargando...");
			
			//FAKE LOGIN
//			userUbiqarama.user = "ubiqa";
//			userUbiqarama.pwd = "4b1c4:";
//			userUbiqarama.user = "yahcov1401294977";
//			userUbiqarama.pwd = "dKeQHoE4UeVc";
//			alert("Fake Login!");
			userUbiqarama.user = sessionStorage.getItem("user");
			userUbiqarama.pwd = sessionStorage.getItem("pwd");	
		
			var _fechaActual = "<span class='icon icon-clock'></span> "+getFecha();
			$("p.fecha").html(_fechaActual);
			
			//Lista de tags
			getTagList();
			
			//Obtener info del usuario y mostrarla
			doLogin = function(result){
				userUbiqarama.user = result.user_alias;
				userUbiqarama.user_id = result.user_id;
				userUbiqarama.url_avatar = result.url_avatar;
				
				$("a#link_user_alias").text(userUbiqarama.user);
				$("div.avatar").css("background","url("+result.url_avatar+") center center");
			}
			APIcalls.login(doLogin);
			
			//Obtener lista de proyectos
			showProjects = function(result){
				var _firstProjectId = 0;
				var _firstProjectName = "";
				var _proyectos = "";
				$.each(result, function (i, proyecto){
					if(_firstProjectId == 0){
						_firstProjectId = proyecto.project_id;
						_firstProjectName = proyecto.project_name;
					}
					_proyectos += "<li><a href='javascript:loadProjectContents("+proyecto.project_id+",\""+proyecto.project_name+"\",true)'>"+proyecto.project_name+"</a></li>";
				});				
				$("li.proyectos").replaceWith(_proyectos);
				
				ddcDialog.hideProgress();
				//Mostrar contenidos del primer proyecto
				loadProjectContents(_firstProjectId, _firstProjectName, false);
			}
			APIcalls.getProjects(showProjects);
			
			
			$.widget( "mobile.loader").html("");
		}
		
		function logOut(){
			function logout_onConfirm(pButtonIndex){
  				if(pButtonIndex == 1){
  					window.location='login.html';
  				}
  			}
  			var _botones = ["Si","No"];
			navigator.notification.confirm("¿Quieres terminar esta sesion ?", logout_onConfirm,"Ubiqarama",_botones);
		}
		
		

		
		
		/**
		 * Muestra los contenidos del proyecto indicado
		 *
		 * @param Id del proyecto cuyos contenidos se quiere visualizar
		 */
		function loadProjectContents(pProjectId, pProjectName, pToggle){
			ddcDialog.showProgress("Cargando Contenidos...");
			showContents = function(result){
				var renderImages = "";
				var renderVideos = "";
				var renderAudios = "";
				
				console.log("Mostrando contenidos del proyecto " + pProjectId + " - " + pProjectName);
				
				//Se recorren todos los contenidos y se generan los elementos de interfaz
				$.each(result, function (i, contenido){
					if(contenido.project_id == pProjectId){
						console.log("Generando contenido " + contenido.content_id);
						//PREPARAR VALORES
						//Coordenadas
						var _coords = (contenido.location != null? contenido.location.lon+","+contenido.location.lat : "");
						//Estado (local / publicado)
						var _icon_content_status = (contenido.content_status == "publish"? "icon-icn-155" : "icon-icn-96");					
						//Nombre
						var _content_name = (contenido.content_name == ""? "SIN NOMBRE" : contenido.content_name);
						//Id
						var _content_id = "contenido_" + contenido.content_id;
						//Ruta al contenido
						var _content_path = (contenido.content_status=="publish" ? contenido.content_url : contenido.local_video_url);
						// Visor
						var _content_viewer = "";
						var _icon_content_type = "";
						if(contenido.content_type == "image"){
							_content_viewer = "<a href='"+_content_path+"' class='img-link'><img src='"+_content_path+"' class='img-responsive'></a>";
							_icon_content_type = "icon-picture";
						}else if(contenido.content_type == "video"){
							if(_content_path.indexOf("youtube") > 0){
								_content_viewer = "<iframe width='100%' height='auto' src='"+_content_path.replace(/watch\?v=/g,"embed/")+"' frameborder='0' allowfullscreen></iframe>";
							}else if(_content_path.indexOf("youtu.be") > 0){
								_content_viewer = "<iframe width='100%' height='auto' src='"+_content_path.replace(/youtu.be/g,"youtube.com/embed/")+"' frameborder='0' allowfullscreen></iframe>";
							}else if(_content_path.indexOf("vimeo") > 0){
								_content_viewer = "<iframe width='100%' height='auto' src='"+_content_path.replace(/vimeo.com/g,"player.vimeo.com/video")+"' frameborder='0' allowfullscreen></iframe>";
							}else{
								_content_viewer = "<video width='100%' height='auto' controls src='"+_content_path+"'>Tu dispositivo no soporta "+contenido.content_type+" HTML5.</video>";	
							}		
							_icon_content_type = "icon-picture";
						}else{
							_content_viewer = "<audio width='100%' height='auto' controls src='"+_content_path+"'>Tu dispositivo no soporta "+contenido.content_type+" HTML5.</audio>";
							_icon_content_type = "icon-icn-65";
						}
						
						//Se genera la interfaz para cada contenido
						var _render_content = ""+
						"<div class='accordion-group galeria'>"+
							"<div class='accordion-heading'>"+
					    		"<a href='#"+_content_id+"' data-parent='#myAccordion' data-toggle='collapse' class='accordion-toggle'><span class='icon "+_icon_content_type+"'></span>"+_content_name+"</a>"+
								"<div class='pull-right'>"+
									"<a href='javascript:removeContent("+contenido.content_id+",\""+contenido.content_name+"\")'><span class='icon icon-icn-288 estampado'></span></a>"+
									"<span class='icon "+_icon_content_status+" estampado'></span>"+
									"<a href='javascript:openLayersUtils.setOrRemoveUbiqaramaMarker("+_coords+")'><span class='icon icon-location'></span></a>"+
								"</div>"+
					   		"</div>"+						    
							"<div class='accordion-body collapse' id='"+_content_id+"'>"+
								"<div class='accordion-inner item'>"+
									_content_viewer+
									"<p>"+contenido.description+"</p>"+
									"<p class='text-center'>";
										$.each(contenido.labels, function (j, label){
											_render_content += "<a class='btn btn-default btn-xs'>"+label.name+"</a>";
										});
										_render_content += ""+
									"</p>"+
									"<p>"+
							    		"<p class='city'>"+contenido.city+"</p>"+
										"<p class='country'>"+contenido.country+"</p>"+
										"<p class='address'>"+contenido.address+"</p>"+ 
									"</p>";
								
							if(contenido.genre !=="" || contenido.age !== ""){
								var _descAge = "";
								if(contenido.age == "10"){_descAge = "entre 14 y 18 a&ntilde;os";}
								else if(contenido.age == "20"){_descAge = "entre 19 y 25 a&ntilde;os";}
								else if(contenido.age == "30"){_descAge = "entre 26 y 35 a&ntilde;os";}
								else if(contenido.age == "50"){_descAge = "mas de 35 a&ntilde;os";}								
								_render_content +=
									"<p>Datos Entrevista:"+
										"<p class='genre'>"+contenido.genre+", "+_descAge+"</p>"+
									"</p>";
							}		
							_render_content +=
								"<p class='text-center'>"+
								"<a class='btn btn-link btn-sm' href='"+ubiqaramaUtils.getURLShareFacebook(contenido.content_name, contenido.content_type)+"'><span class='icon icon-facebook-squared' style='font-size:25px'></span></a>"+
								"<a class='btn btn-link btn-sm' href='"+ubiqaramaUtils.getURLShareTwitter(contenido.content_name, contenido.content_type)+"'><span class='icon icon-ic-webfont' style='font-size:25px'></span></a>"+
								"<a class='btn btn-link btn-sm' href='"+ubiqaramaUtils.getURLShareMail(contenido.content_name, contenido.content_type)+"'><span class='icon icon-icn-296' style='font-size:25px'></span></a>"+
								"<a class='btn btn-link btn-sm' href='"+ubiqaramaUtils.getURLShareTuenti(contenido.content_name, contenido.content_type)+"'><span class='icon icon-icn-16' style='font-size:25px'></span></a>"+
								"</p>"+
							    "</div>"+
						    "</div>"+
						"</div>";
	
						//Se agrega a la interfaz general de este tipo de contenido
						if(contenido.content_type == "image"){//Imagenes
							renderImages += _render_content;
						}else if(contenido.content_type == "video"){//Videos
							renderVideos += _render_content;						
						}else if(contenido.content_type == "audio"){//Audios
							renderAudios += _render_content;
						}else{//OTROS
							ubiqaramaUtils.alert("Tipo de contenido no soportado:"+contenido.content_type);
							_content_viewer = "<video width='100%' height='auto' controls src='"+_content_path+"'>Tu dispositivo no soporta audio HTML5.</video> ";
						}				
					}
				});
				
				//Se muestran los contenidos
				$("div.contents_image").html(renderImages);
				$("div.contents_video").html(renderVideos);
				$("div.contents_audio").html(renderAudios);		
				
				//Se repliega el menu
				if(pToggle){$("div#wrapper").toggleClass("active")};
				
				ddcDialog.hideProgress();
			}
			APIcalls.getContents(pProjectId, showContents);
			
			$("h2.project_name").html(pProjectName);
			currentProjectID = pProjectId;
			currentProjectName = pProjectName;
		}
		
		
		function addContent(pContentType){
			if(isEditing){
				ubiqaramaUtils.alert("Ya estas agregando otro contenido. Por favor finaliza la operacion actual antes de iniciar una nueva");
				return;
			}
			isEditing = true;
			console.log("Entra en agregar contenido - "+pContentType);
			//Grabar el clip de audio
			function capturaOK(pMediaFile){
				//Mostrar interfaz de edicion		
				showEditContent(pContentType,pMediaFile.fullPath);
				
			}
			function capturaError(error){
				ubiqaramaUtils.alert("Error grabando " + pContentType + ", intentelo de nuevo");
				isEditing = false;
			}
			console.log("antes de lanzar captura");
			if(pContentType == "audio"){
				ddcCaptureUtils.captureAudio(capturaOK, capturaError);	
			}else if(pContentType == "image"){
				ddcCaptureUtils.captureImage(capturaOK, capturaError);
			}else if(pContentType == "video"){
				ddcCaptureUtils.captureVideo(capturaOK, capturaError);
			}else{
				
			}
			
		}
		
		function removeContent(pContentId, pContentName){
          	function remove_onConfirm(pButtonIndex){
  				if(pButtonIndex == 1){
  					ddcDialog.showProgress("Eliminando Contenido...");
  					//Se elimina el contenido
  					function removeOK(pContent){
  						ddcDialog.hideProgress();
  						ubiqaramaUtils.alert("Contenido eliminado");
  						loadProjectContents(currentProjectID, currentProjectName,false);
  					}
  					function removeError(error){
  						ddcDialog.hideProgress();
  						ubiqaramaUtils.alert("Error eliminando el contenido '" + pContentName + "'', intentelo de nuevo");
  					}
  					APIcalls.removeContent(pContentId, removeOK, removeError );
  				}
  			}
  			var _botones = ["Si","No"];
			navigator.notification.confirm("¿Realmente quieres eliminar el contenido '"+pContentName+"'?", remove_onConfirm,"Ubiqarama",_botones);
		}
		


		
		
		function showEditContent(pContentType, pFileURL){
			var _content_viewer = "";
			if(pContentType == "image"){
				_content_viewer = "<a href='"+pFileURL+"' class='img-link'><img src='"+pFileURL+"' class='img-responsive'></a>";
			}else if(pContentType == "video"){
				_content_viewer = "<video width='100%' height='auto' controls src='"+pFileURL+"'>Tu dispositivo no soporta "+pContentType+" HTML5.</video>";	
			}else{
				_content_viewer = "<audio width='100%' height='auto' controls src='"+pFileURL+"'>Tu dispositivo no soporta "+pContentType+" HTML5.</audio>";
			}
			
			
			var _renderEditor = ""+
					"<div class='accordion-inner item'>"+
						_content_viewer+
						"<p><input id='txt_content_name' name='content_name' type='text' class='form-control content_name' placeholder='Nombre' required autofocus/></p>"+
						"<p><textarea id='txt_description' name='description' type='text' class='form-control description campo_editable_con_formato' placeholder='Descripcion' cols='5'/></p>"+
						"<p class='text-center'>";
							_renderEditor += ""+
						"</p>"+
						"<p>"+
							"<p class='city'><input id='txt_city' name='city' type='text' class='form-control city' placeholder='Ciudad'/></p>"+
							"<p class='country'><input id='txt_country' name='country' type='text' class='form-control country' placeholder='Pais'/></p>"+
							"<p class='address'><input id='txt_address' name='address' type='text' class='form-control address' placeholder='Direccion'/></p>"+
							"<p class='coordenadas'><a href='javascript:getCoordenadas()'><span class='icon icon-location'></span>Coordenadas:</a> Calculando...</p>"+
							"<input id='txt_longitude' type='hidden'/><input id='txt_latitude' type='hidden'/>"+
				    	"</p>"+
				    	
						"<div class='accordion-heading'>"+
				    		"<a href='#edit_entrevista' data-parent='#myAccordion' data-toggle='collapse' class='accordion-toggle'>Datos Entrevista</a>"+
				   		"</div>"+
						"<div class='accordion-body collapse' id='edit_entrevista'>"+
							"<div class='accordion-inner item'>"+
								"<div class='btn-group' data-toggle='buttons'>"+
									"<label class='btn btn-primary btn-sm btn-danger btn-block'><input type='radio' class='optGenre' name='nik_genre' id='radio_genero' value='hombre'>Hombre</label>"+
									"<label class='btn btn-primary btn-sm btn-danger btn-block'><input type='radio' class='optGenre' name='nik_genre' id='radio_genero' value='mujer'> Mujer</label>"+
								"</div>"+
								"<div class='btn-group'>"+
									"<button type='button' class='btn btn-default dropdown-toggle selector_edad' data-toggle='dropdown' data-value='0'>Selecciona rango de edad</button>"+
									"<ul class='dropdown-menu' role='menu'>"+
										"<li role='menuitem'><a class='edad_10' href='javascript:setAge(\"edad_10\")' title='Entre 14 y 18 años' data-value='10'>Entre 14 y 18 años</a></li>"+
										"<li role='menuitem'><a class='edad_20' href='javascript:setAge(\"edad_20\")' title='Entre 19 y 25 años' data-value='20'>Entre 19 y 25 años</a></li>"+
										"<li role='menuitem'><a class='edad_30' href='javascript:setAge(\"edad_30\")' title='Entre 26 y 35 años' data-value='30'>Entre 26 y 35 años</a></li>"+
										"<li role='menuitem'><a class='edad_50' href='javascript:setAge(\"edad_50\")' title='Más de 35 años'     data-value='50'>Más de 35 años</a></li>"+
									"</ul>"+
								"</div>"+							
							"</div>"+
						"</div>"+

				    	
				    	getTagList()+
				    	"<p ><button type'button' class='btn btn-link text-left' onclick='sendContent(\""+pContentType+"\",\""+pFileURL+"\")'>Aceptar</button>"+	           
				    	"<button type'button' class='btn btn-link text-right' onclick='cancelEdit()'>Cancelar</button></p>"+
			    	"</div>";
			$("div.contents_"+pContentType).html(_renderEditor);
			
			getCoordenadas();
			
			var editor = new MediumEditor('.campo_editable_con_formato');
		}
		
		function getCoordenadas(){
			$("p.coordenadas").html("<a href='javascript:getCoordenadas()'><span class='icon icon-location'></span>Coordenadas:</a> Calculando...");
			
			function getCoordsOK(pPosition){
				//Mostrar
				$("#txt_longitude").val(pPosition.coords.longitude);
				$("#txt_latitude").val(pPosition.coords.latitude);
				$("p.coordenadas").html("<a href='javascript:getCoordenadas()'><span class='icon icon-location'></span>Coordenadas:</a><br/> Longitud="+pPosition.coords.longitude+", Latitud="+pPosition.coords.latitude);
				
			}
			function getCoordsError(pError){
				ubiqaramaUtils.alert('Error al obtener la ubicacion actual.\ncode: '+error.code+''+'message: '+error.message);
			}
			//Obtener coordenadas
			ddcGeolocationUtils.getLocation(getCoordsOK, getCoordsError);
			
			
		}
		
		
		function sendContent(pContentType, pFileURL){
			
			ddcDialog.showProgress("Enviando Nuevo Contenido...");
			
			//Se envia la informacion
			function sendContentOK(result){
				console.log(pContentType + " enviado");
				ddcDialog.hideProgress();
				ubiqaramaUtils.alert(pContentType + " enviado con exito!");
				//Se recarga el proyecto
				isEditing = false;
				loadProjectContents(currentProjectID, currentProjectName,false);
			}
			function sendContentError(error){
				ddcDialog.hideProgress();
				console.error("Error al enviar el contenido grabado : " + error.code + ", " + error.source + " - " + error.target);
				ubiqaramaUtils.alert("Error al enviar el audio grabado, intentelo de nuevo (" + error.code + ", " + error.source + " - " + error.target + ")");				
			}
			
			var offLine = (pContentType == "video");
			
			var selectedGenre = "";
			$.each($(".optGenre:checked"), function (i, genre){
				selectedGenre = genre.value;
			});

            var params = {
        			'project_id'		: currentProjectID,
        			'content_name'		: $("#txt_content_name").val(),
        			'content_status'	: (offLine ? "pending" : "publish"),
        			'local_video_url'	:(offLine ? pFileURL : ""),
        			'date'				: getFechaYHora(),
        			'description'		: $("#txt_description").val(),
        			'location[lon]'		: $("#txt_longitude").val(),
        			'location[lat]'		: $("#txt_latitude").val(),
        			'language'			: "es",
        			'age'				: $(".selector_edad").val(),
        			'genre'				: selectedGenre,
        			'city'				: $("#txt_city").val(),
        			'country'			: $("#txt_country").val(),
        			'address'			: $("#txt_address").val(),
        			'content_type'		: pContentType
            };
            //Etiquetas
            $.each($(".chkTag:checked"), function (i, tag){
            	params['themes['+i+']'] = parseInt(tag.value);
            });

            if(offLine){
            	APIcalls.addContent(pContentType, "data:base64,xxxx", params, sendContentOK, sendContentError);
            }else{
            	APIcalls.addContent(pContentType, pFileURL, params, sendContentOK, sendContentError);	
            }
            

            
   
            
			
		}
		
		function cancelEdit(){
			//Se pide confirmacion
			function onConfirm(pButtonIndex){
				if(pButtonIndex == 1){
					//Se recarga el proyecto
					isEditing = false;
					loadProjectContents(currentProjectID, currentProjectName,false);
				}
			}
			var _botones = ["Si","No"];
			navigator.notification.confirm("¿Deseas cancelar el nuevo contenido?", onConfirm, "Ubiqarama",_botones);
			
		}
		
		$.widget( "mobile.loader").html("");
		
		
		
		
		
		
		
		
		
		
		

		
		
		
	</script>
<!-- Fin YYY -->    
  </body>
</html>
